<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Namo Tandoori Chai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <style>
        :root {
            --background-light: #f9fafb; --foreground-light: #111827; --card-light: #ffffff; --card-foreground-light: #111827; --popover-light: #ffffff; --popover-foreground-light: #111827; --primary-light: #8B4513; --primary-foreground-light: #f9fafb; --secondary-light: #f3f4f6; --secondary-foreground-light: #111827; --muted-light: #f3f4f6; --muted-foreground-light: #6b7280; --accent-light: #f3f4f6; --accent-foreground-light: #111827; --destructive-light: #ef4444; --destructive-foreground-light: #f9fafb; --border-light: #e5e7eb; --input-light: #e5e7eb; --ring-light: #8B4513;
            --background-dark: #09090b; --foreground-dark: #fafafa; --card-dark: #18181b; --card-foreground-dark: #fafafa; --popover-dark: #09090b; --popover-foreground-dark: #fafafa; --primary-dark: #D2B48C; --primary-foreground-dark: #09090b; --secondary-dark: #27272a; --secondary-foreground-dark: #fafafa; --muted-dark: #27272a; --muted-foreground-dark: #a1a1aa; --accent-dark: #27272a; --accent-foreground-dark: #fafafa; --destructive-dark: #7f1d1d; --destructive-foreground-dark: #fafafa; --border-dark: #27272a; --input-dark: #27272a; --ring-dark: #D2B48C;
        }
        .light {
            --background: var(--background-light); --foreground: var(--foreground-light); --card: var(--card-light); --card-foreground: var(--card-foreground-light); --popover: var(--popover-light); --popover-foreground: var(--popover-foreground-light); --primary: var(--primary-light); --primary-foreground: var(--primary-foreground-light); --secondary: var(--secondary-light); --secondary-foreground: var(--secondary-foreground-light); --muted: var(--muted-light); --muted-foreground: var(--muted-foreground-light); --accent: var(--accent-light); --accent-foreground: var(--accent-foreground-light); --destructive: var(--destructive-light); --destructive-foreground: var(--destructive-foreground-light); --border: var(--border-light); --input: var(--input-light); --ring: var(--ring-light);
        }
        .dark {
            --background: var(--background-dark); --foreground: var(--foreground-dark); --card: var(--card-dark); --card-foreground: var(--card-foreground-dark); --popover: var(--popover-dark); --popover-foreground: var(--popover-foreground-dark); --primary: var(--primary-dark); --primary-foreground: var(--primary-foreground-dark); --secondary: var(--secondary-dark); --secondary-foreground: var(--secondary-foreground-dark); --muted: var(--muted-dark); --muted-foreground: var(--muted-foreground-dark); --accent: var(--accent-dark); --accent-foreground: var(--accent-foreground-dark); --destructive: var(--destructive-dark); --destructive-foreground: var(--destructive-foreground-dark); --border: var(--border-dark); --input: var(--input-dark); --ring: var(--ring-dark);
        }
        body { background-color: var(--background); color: var(--foreground); font-family: 'Hind', sans-serif; }
        .font-display { font-family: 'Laila', sans-serif; }
        .bg-card { background-color: var(--card); }
        .text-card-foreground { color: var(--card-foreground); }
        .border-border { border-color: var(--border); }
        .bg-primary { background-color: var(--primary); }
        .text-primary-foreground { color: var(--primary-foreground); }
        .bg-secondary { background-color: var(--secondary); }
        .text-secondary-foreground { color: var(--secondary-foreground); }
        .text-muted-foreground { color: var(--muted-foreground); }
        .bg-destructive { background-color: var(--destructive); }
        .text-destructive-foreground { color: var(--destructive-foreground); }
        .modal-overlay { animation: fadeIn 0.3s ease; }
        .modal-content { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .spinner { border: 2px solid white; border-top: 2px solid transparent; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">
    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-secondary flex items-center justify-center z-[100]">
        <div class="w-full max-w-sm bg-card p-8 rounded-lg shadow-md">
            <h2 class="font-display text-2xl font-bold text-center text-card-foreground mb-2">Namo Chai Admin</h2>
            <p class="text-center text-muted-foreground mb-6">Please sign in to continue</p>
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="email" class="text-sm font-medium">Email</label>
                        <input type="email" id="email-input" class="w-full mt-1 p-2 bg-secondary rounded-md border border-border" required>
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium">Password</label>
                        <input type="password" id="password-input" class="w-full mt-1 p-2 bg-secondary rounded-md border border-border" required>
                    </div>
                </div>
                <p id="login-error" class="text-destructive text-sm text-center mt-4 h-5"></p>
                <button type="submit" class="w-full bg-primary text-primary-foreground font-semibold py-2 px-4 rounded-lg mt-4 flex items-center justify-center">
                    <span id="login-btn-text">Sign In</span>
                    <div id="login-spinner" class="spinner hidden ml-2"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Main App Container (Desktop) -->
    <div id="app-container" class="hidden">
        <div class="flex h-screen bg-secondary">
            <!-- Sidebar -->
            <aside class="w-64 flex-shrink-0 bg-card border-r border-border flex flex-col">
                <div class="h-16 flex items-center justify-center border-b border-border">
                    <h1 class="font-display text-2xl font-bold text-card-foreground">Namo Chai</h1>
                </div>
                <nav id="sidebar-nav" class="flex-grow p-4 space-y-2">
                    <!-- Nav items will be injected by JS -->
                </nav>
                <div class="p-4 border-t border-border space-y-2">
                    <button id="theme-toggle" class="w-full flex items-center justify-center p-2 rounded-lg bg-secondary text-secondary-foreground">
                        <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    </button>
                    <button id="logout-btn" class="w-full flex items-center px-4 py-2 text-sm font-medium rounded-lg text-muted-foreground hover:bg-secondary">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                        Logout
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <header class="h-16 bg-card border-b border-border flex items-center justify-between px-6">
                    <h2 id="page-title" class="text-xl font-semibold text-card-foreground">Dashboard</h2>
                    <div id="user-email" class="text-sm text-muted-foreground"></div>
                </header>
                <div id="page-content" class="flex-1 overflow-y-auto p-6 space-y-6">
                    <!-- Content will be injected by JS -->
                </div>
            </main>
        </div>
    </div>

    <!-- Mobile App Container -->
    <div id="mobile-container" class="hidden"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-5 right-5 bg-primary text-primary-foreground py-2 px-4 rounded-lg shadow-lg text-sm z-[200]">
        <p id="toast-message"></p>
    </div>

    <!-- Live Alert Modal -->
    <div id="live-alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[101]">
        <div id="live-alert-content" class="bg-card p-8 rounded-lg shadow-2xl text-center w-full max-w-md transform transition-all modal-content">
            <!-- Content injected by JS -->
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>
    <audio id="notification-sound" src="https://otmnwdhhdkowonfiqdfu.supabase.co/storage/v1/object/public/assets/notification-sound-effect-372475.mp3" preload="auto"></audio>

<script>
// =================================================================================
//  SECTION 1: SETUP & AUTHENTICATION
// =================================================================================
const $ = (selector) => document.querySelector(selector);

const SUPABASE_URL = 'https://otmnwdhhdkowonfiqdfu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90bW53ZGhoZGtvd29uZmlxZGZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2ODQ5MzAsImV4cCI6MjA3NjI2MDkzMH0.mBb416oa2BVEJ8lV56PRRHmDviEis7x8hYUJCjMGlo8';
const supabase = self.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const notificationSound = $('#notification-sound');

const state = {
    user: null,
    currentPage: 'dashboard',
    posCart: [],
    menuData: [],
};

const ICONS = {
    dashboard: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`,
    pos: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1v-1m0 0a2.5 2.5 0 100 5 2.5 2.5 0 000-5zm-3.293 8.293a2.5 2.5 0 013.536 0L14 17.5M12 21a9 9 0 100-18 9 9 0 000 18z" /></svg>`,
    orders: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 9h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>`,
    menu: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`,
    customers: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`,
    analytics: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" /></svg>`,
    feedback: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>`,
    games: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
    qr: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zM13 3v8h8V3h-8zm6 6h-4V5h4v4zM13 21h8v-8h-8v8zm2-6h4v4h-4v-4z"/></svg>`
};

const PAGES = {
    dashboard: { title: "Dashboard", icon: ICONS.dashboard, render: renderDashboard },
    pos: { title: "POS Terminal", icon: ICONS.pos, render: renderPos },
    orders: { title: "Orders & KOT", icon: ICONS.orders, render: renderOrders },
    menu: { title: "Menu Management", icon: ICONS.menu, render: renderMenu },
    customers: { title: "Customers", icon: ICONS.customers, render: renderCustomers },
    analytics: { title: "Analytics", icon: ICONS.analytics, render: renderAnalytics },
    feedback: { title: "Feedback", icon: ICONS.feedback, render: renderFeedback },
    games: { title: "Games & Slang", icon: ICONS.games, render: renderGames },
    qr: { title: "QR Generator", icon: ICONS.qr, render: renderQrGenerator },
    pos_bridge: { title: "POS Order Entry", render: renderPosBridge, isHidden: true }
};

const auth = {
    async login() {
        const email = $('#email-input').value;
        const password = $('#password-input').value;
        $('#login-spinner').classList.remove('hidden');
        $('#login-btn-text').classList.add('hidden');
        $('#login-error').textContent = '';

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        $('#login-spinner').classList.add('hidden');
        $('#login-btn-text').classList.remove('hidden');

        if (error) {
            $('#login-error').textContent = error.message;
        } else if (data.user) {
            state.user = data.user;
            this.initializeApp();
        }
    },

    async logout() {
        await supabase.auth.signOut();
        location.reload();
    },

    initializeApp() {
        $('#login-screen').classList.add('hidden');
        applyTheme(localStorage.getItem('theme') || 'light');
        live.init();

        if (isMobile()) {
            this.renderMobileView();
        } else {
            $('#app-container').classList.remove('hidden');
            $('#user-email').textContent = state.user.email;
            navigateTo('dashboard');
        }
    },
    
    renderMobileView() {
        $('#mobile-container').classList.remove('hidden');
        $('#mobile-container').innerHTML = `
            <header class="h-16 bg-card border-b border-border flex items-center justify-between px-4 shadow-sm sticky top-0 z-10">
                <h1 class="font-display text-xl font-bold text-card-foreground">Namo Chai - Live View</h1>
                <button id="mobile-logout-btn" class="text-sm font-medium text-destructive hover:underline">Logout</button>
            </header>
            <main id="mobile-page-content" class="p-4 space-y-6 bg-secondary min-h-screen"></main>
        `;
        renderDashboard($('#mobile-page-content'));
        $('#mobile-logout-btn').addEventListener('click', this.logout);
    },

    async checkSession() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            state.user = session.user;
            this.initializeApp();
        } else {
            $('#login-screen').classList.remove('hidden');
        }
    }
};

// =================================================================================
//  SECTION 2: CORE UI & NAVIGATION
// =================================================================================

function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

function navigateTo(page, params = null) {
    if (!PAGES[page]) return;
    state.currentPage = page;
    
    $('#sidebar-nav').innerHTML = Object.keys(PAGES).map(key => {
        const p = PAGES[key];
        if (p.isHidden) return '';
        const isActive = state.currentPage === key;
        return `<button onclick="navigateTo('${key}')" class="w-full flex items-center px-4 py-2 text-sm font-medium rounded-lg ${isActive ? 'bg-primary text-primary-foreground' : 'text-muted-foreground hover:bg-secondary'}">${p.icon}${p.title}</button>`;
    }).join('');

    $('#page-title').textContent = PAGES[state.currentPage].title;
    const contentContainer = $('#page-content');
    contentContainer.innerHTML = `<div class="text-center text-muted-foreground">Loading...</div>`;
    PAGES[state.currentPage].render(contentContainer, params);
}

function showToast(message, isError = false) {
    const toast = $('#toast');
    $('#toast-message').textContent = message;
    toast.className = `fixed bottom-5 right-5 text-primary-foreground py-2 px-4 rounded-lg shadow-lg text-sm z-[200] ${isError ? 'bg-destructive' : 'bg-primary'}`;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

function showModal(id, content) {
    let modal = document.createElement('div');
    modal.id = id;
    modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal-overlay p-4";
    modal.innerHTML = `<div class="bg-card rounded-lg shadow-xl p-6 w-full max-w-md modal-content">${content}</div>`;
    $('#modal-container').appendChild(modal);
}

function closeModal(id) {
    const modal = $(`#${id}`);
    if (modal) modal.remove();
}

function showLiveAlert(content) {
    notificationSound.loop = true;
    notificationSound.play().catch(e => console.warn("Audio notification failed:", e));
    $('#live-alert-content').innerHTML = content;
    $('#live-alert-modal').classList.remove('hidden');
}

function hideLiveAlert() {
    notificationSound.pause();
    notificationSound.currentTime = 0;
    notificationSound.loop = false;
    $('#live-alert-modal').classList.add('hidden');
}


// =================================================================================
//  SECTION 3: LIVE DATA & PAGE RENDERERS
// =================================================================================
const live = {
    init() {
        this.listenForChanges();
    },
    listenForChanges() {
        supabase.channel('public-changes')
            .on('postgres_changes', { event: '*', schema: 'public' }, async payload => {
                const targetContainer = isMobile() ? $('#mobile-page-content') : $('#page-content');
                const targetPage = isMobile() ? 'dashboard' : state.currentPage;
                
                const refreshablePages = ['dashboard', 'orders', 'customers', 'feedback', 'menu', 'games'];
                if (refreshablePages.includes(targetPage)) {
                    PAGES[targetPage].render(targetContainer);
                }

                if (payload.eventType === 'INSERT') {
                    if (payload.table === 'orders') {
                        const { data: order } = await supabase.from('orders').select('*, customers(name), tables(table_number)').eq('id', payload.new.id).single();
                        
                        const buttons = isMobile()
                            ? `<button onclick="hideLiveAlert()" class="bg-primary text-primary-foreground px-6 py-3 rounded-lg font-bold w-full">Acknowledge</button>`
                            : `<div class="flex gap-2 justify-center">
                                <button onclick="openPosBridge('${order.id}')" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold">Enter in POS</button>
                                <button onclick="hideLiveAlert()" class="bg-primary text-primary-foreground px-6 py-3 rounded-lg font-bold">Acknowledge</button>
                            </div>`;

                        showLiveAlert(`
                            <h2 class="font-display text-3xl font-bold text-destructive mb-4">New Order!</h2>
                            <p class="text-lg text-muted-foreground mb-1">Table #${order.tables?.table_number || 'N/A'}</p>
                            <p class="text-lg text-muted-foreground mb-6">By ${order.customers?.name || 'N/A'}</p>
                            ${buttons}
                        `);
                    }
                    if (payload.table === 'staff_calls' && payload.new.status === 'pending') {
                         const { data: call } = await supabase.from('staff_calls').select('*, customers(name), tables(table_number)').eq('id', payload.new.id).single();
                        showLiveAlert(`
                            <h2 class="font-display text-3xl font-bold text-orange-500 mb-4">Staff Call!</h2>
                            <p class="text-lg text-muted-foreground mb-1">From Table #${call.tables?.table_number || 'N/A'}</p>
                            <p class="text-lg text-muted-foreground mb-6">By ${call.customers?.name || 'N/A'}</p>
                            <button onclick="hideLiveAlert()" class="bg-primary text-primary-foreground px-6 py-3 rounded-lg font-bold">Acknowledge</button>
                        `);
                    }
                }
            })
            .subscribe();
    }
};

async function renderDashboard(container) {
    if (!container) return;
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="font-display text-xl mb-4">Live Orders</h3>
                <div id="live-orders" class="space-y-3"></div>
            </div>
            <div>
                <h3 class="font-display text-xl mb-4">Staff Calls</h3>
                <div id="staff-calls" class="space-y-3"></div>
            </div>
        </div>`;

    const [ordersRes, callsRes] = await Promise.all([
        supabase.from('orders').select('*, customers(name), tables(table_number), order_items(*, products(name))').in('status', ['received', 'preparing']),
        supabase.from('staff_calls').select('*, customers(name), tables(table_number)').eq('status', 'pending')
    ]);

    const ordersContainer = container.querySelector('#live-orders');
    if (ordersRes.error) {
        ordersContainer.innerHTML = `<p class="text-destructive">Error loading orders.</p>`;
        console.error("Order fetch error:", ordersRes.error);
    } else if (ordersRes.data.length === 0) {
        ordersContainer.innerHTML = `<p class="text-muted-foreground">No active orders.</p>`;
    } else {
        ordersContainer.innerHTML = ordersRes.data.map(order => {
            const mobileView = isMobile();
            return `
            <div class="bg-card p-4 rounded-lg shadow-sm border-border border">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-card-foreground">Table ${order.tables.table_number}</p>
                        <p class="text-sm text-muted-foreground">${order.customers.name}</p>
                    </div>
                    <span class="font-semibold capitalize text-xs p-1 rounded ${order.status === 'received' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">${order.status}</span>
                </div>
                <hr class="my-3 border-border">
                <div>
                    <p class="text-sm font-semibold mb-2">Order Items:</p>
                    <ul class="space-y-1 text-sm pl-2">
                        ${order.order_items.map(item => `
                            <li class="flex justify-between">
                                <span>- ${item.quantity} x ${item.products ? item.products.name : '[Deleted Item]'}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-2">
                    ${!mobileView ? `<button onclick="openPosBridge('${order.id}')" class="w-full col-span-2 bg-blue-500 text-white font-semibold p-2 rounded-md text-sm">Enter in POS</button>` : ''}
                    ${order.status === 'received' ? `<button onclick="updateOrderStatus('${order.id}', 'preparing')" class="w-full ${mobileView ? 'col-span-2' : ''} bg-secondary text-secondary-foreground font-semibold p-2 rounded-md text-sm">Start Preparing</button>` : ''}
                    ${order.status === 'preparing' ? `<button onclick="updateOrderStatus('${order.id}', 'delivered')" class="w-full ${mobileView ? 'col-span-2' : ''} bg-green-500 text-white font-semibold p-2 rounded-md text-sm">Mark Delivered</button>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    const callsContainer = container.querySelector('#staff-calls');
    if (callsRes.error) callsContainer.innerHTML = `<p class="text-destructive">Error loading calls.</p>`;
    else if (callsRes.data.length === 0) callsContainer.innerHTML = `<p class="text-muted-foreground">No active calls.</p>`;
    else {
         callsContainer.innerHTML = callsRes.data.map(call => `
            <div class="bg-card p-4 rounded-lg shadow-sm border-border border flex justify-between items-center">
                 <div>
                    <p class="font-bold text-card-foreground">Call from Table ${call.tables.table_number}</p>
                    <p class="text-sm text-muted-foreground">${call.customers.name}</p>
                </div>
                <button onclick="resolveStaffCall('${call.id}')" class="bg-green-500 text-white font-semibold py-1 px-3 rounded-md text-sm">Resolve</button>
            </div>`).join('');
    }
}

async function renderPos(container) {
     if (state.menuData.length === 0) {
        const { data, error } = await supabase.from('products').select('*').eq('is_available', true).order('category');
        if (error) { container.innerHTML = `<p class="text-destructive">Could not load menu.</p>`; return; }
        state.menuData = data.reduce((acc, item) => {
            if (!acc[item.category]) acc[item.category] = [];
            acc[item.category].push(item);
            return acc;
        }, {});
    }

    container.innerHTML = `
        <div class="grid grid-cols-3 gap-6 h-full">
            <div class="col-span-2 bg-card border border-border rounded-lg p-4 overflow-y-auto">
                <h3 class="font-display text-xl mb-4">Menu</h3>
                <div id="pos-menu-items" class="space-y-4"></div>
            </div>
            <div class="col-span-1 bg-card border border-border rounded-lg p-4 flex flex-col">
                <h3 class="font-display text-xl mb-4">Current Order</h3>
                <div id="pos-cart" class="flex-grow space-y-2 overflow-y-auto"><p class="text-muted-foreground text-sm">Select items from the menu.</p></div>
                <div class="mt-4 pt-4 border-t border-border">
                    <div class="flex justify-between font-bold text-lg mb-4"><span>Total</span><span id="pos-total">₹0.00</span></div>
                    <input type="number" id="pos-table-number" class="w-full p-2 bg-secondary rounded-md border border-border mb-2" placeholder="Table Number" required>
                    <input type="text" id="pos-customer-name" class="w-full p-2 bg-secondary rounded-md border border-border mb-4" placeholder="Customer Name (optional)">
                    <button id="pos-place-order" class="w-full bg-primary text-primary-foreground font-semibold py-3 rounded-lg">Place Order</button>
                </div>
            </div>
        </div>
    `;

    $('#pos-menu-items').innerHTML = Object.keys(state.menuData).map(category => `
        <div>
            <h4 class="font-semibold text-muted-foreground mb-2">${category}</h4>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                ${state.menuData[category].map(item => `<button onclick="pos.addToCart(${item.id})" class="bg-secondary p-2 rounded-md text-left text-sm"><p class="font-semibold">${item.name}</p><p class="text-xs text-muted-foreground">₹${item.price}</p></button>`).join('')}
            </div>
        </div>
    `).join('');
    
    $('#pos-place-order').addEventListener('click', pos.placeOrder);
    pos.renderCart();
}

async function renderOrders(container){
     container.innerHTML = `
        <div class="bg-card p-4 rounded-lg shadow-sm">
            <div id="orders-table-body"><p class="text-center text-muted-foreground p-4">Loading order history...</p></div>
        </div>
    `;

    const { data, error } = await supabase.from('orders').select('*, customers(name), tables(table_number), order_items(*)').order('created_at', { ascending: false });
    const tableBody = $('#orders-table-body');

    if(error){ tableBody.innerHTML = `<p class="text-destructive">Failed to load orders.</p>`; return; }
    
    tableBody.innerHTML = data.map(order => `
        <div class="border-b border-border p-4">
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-bold">Order #${order.id.slice(0,6)} <span class="text-sm text-muted-foreground font-normal">- ${new Date(order.created_at).toLocaleString()}</span></p>
                    <p class="text-sm">Table: ${order.tables.table_number} | Customer: ${order.customers.name}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold">₹${order.total_amount.toFixed(2)}</p>
                    <span class="font-semibold capitalize text-xs p-1 rounded ${order.status === 'delivered' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${order.status}</span>
                </div>
            </div>
            <div class="mt-2 flex space-x-4">
                <button onclick="openPosBridge('${order.id}')" class="text-blue-600 hover:underline text-sm font-semibold">Enter in POS</button>
                <button onclick="pos.printKOT('${order.id}')" class="text-blue-600 hover:underline text-sm font-semibold">Print KOT</button>
                <button onclick="deleteOrder('${order.id}')" class="text-destructive hover:underline text-sm font-semibold">Delete</button>
            </div>
        </div>
    `).join('');
}

async function renderMenu(container){
     container.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Menu Items</h3>
            <button id="add-item-btn" class="bg-primary text-primary-foreground px-4 py-2 rounded-lg text-sm font-medium">Add New Item</button>
        </div>
        <div class="bg-card rounded-lg shadow-sm">
            <div id="menu-table-body" class="divide-y divide-border"></div>
        </div>
    `;

    const loadMenu = async () => {
        const { data: products, error } = await supabase.from('products').select('*').order('category').order('name');
        
        const tableBody = $('#menu-table-body');
        if (!tableBody) return;
        if (error) { showToast(`Failed to load menu: ${error.message}`, true); return; }

        tableBody.innerHTML = `
             <div class="grid grid-cols-6 gap-4 font-semibold text-sm text-muted-foreground px-4 py-2 border-b">
                <div class="col-span-2">Name</div>
                <div>Category</div>
                <div>Price</div>
                <div>Available</div>
                <div>Actions</div>
            </div>
            ${products.map(item => `
                <div class="grid grid-cols-6 gap-4 items-center px-4 py-3 text-sm">
                    <div class="col-span-2 font-medium">${item.name}</div>
                    <div>${item.category}</div>
                    <div>₹${item.price}</div>
                    <div><span class="px-2 py-1 text-xs rounded-full ${item.is_available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${item.is_available ? 'Yes' : 'No'}</span></div>
                    <div class="space-x-2">
                        <button class="edit-item-btn text-blue-600 hover:underline" data-id="${item.id}">Edit</button>
                        <button class="delete-item-btn text-destructive hover:underline" data-id="${item.id}">Delete</button>
                    </div>
                </div>
            `).join('')}`;
    };

    const openModal = (item = null) => {
        showModal('menu-modal', `
            <h3 id="modal-title" class="text-lg font-semibold mb-4">${item ? 'Edit' : 'Add'} Menu Item</h3>
            <form id="menu-item-form" class="space-y-4">
                <input type="hidden" id="item-id" value="${item?.id || ''}">
                <div>
                    <label class="text-sm font-medium">Name</label>
                    <input type="text" id="item-name" class="w-full mt-1 p-2 bg-secondary rounded-md border border-border" value="${item?.name || ''}" required>
                </div>
                <div>
                    <label class="text-sm font-medium">Category</label>
                    <input type="text" id="item-category" class="w-full mt-1 p-2 bg-secondary rounded-md border border-border" value="${item?.category || ''}" required>
                </div>
                <div>
                    <label class="text-sm font-medium">Price</label>
                    <input type="number" id="item-price" step="0.01" class="w-full mt-1 p-2 bg-secondary rounded-md border border-border" value="${item?.price || ''}" required>
                </div>
                <div>
                    <label class="text-sm font-medium">Description</label>
                    <textarea id="item-description" class="w-full mt-1 p-2 bg-secondary rounded-md border border-border" rows="2">${item?.description || ''}</textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="item-available" class="h-4 w-4 rounded border-gray-300" ${item ? (item.is_available ? 'checked' : '') : 'checked'}>
                    <label for="item-available" class="ml-2 text-sm font-medium">Is Available</label>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" onclick="closeModal('menu-modal')" class="bg-secondary text-secondary-foreground px-4 py-2 rounded-lg text-sm">Cancel</button>
                    <button type="submit" class="bg-primary text-primary-foreground px-4 py-2 rounded-lg text-sm">Save</button>
                </div>
            </form>
        `);
        $('#menu-item-form').addEventListener('submit', handleMenuFormSubmit);
    };

    const handleMenuFormSubmit = async (e) => {
        e.preventDefault();
        const id = $('#item-id').value;
        const itemData = {
            name: $('#item-name').value,
            category: $('#item-category').value,
            price: parseFloat($('#item-price').value),
            description: $('#item-description').value,
            is_available: $('#item-available').checked
        };

        const { error } = id
            ? await supabase.from('products').update(itemData).eq('id', id)
            : await supabase.from('products').insert([itemData]);
        
        if (error) { showToast(`Error: ${error.message}`, true); } 
        else {
            showToast(`Item ${id ? 'updated' : 'added'}.`);
            closeModal('menu-modal');
        }
    };
    
    await loadMenu();

    $('#add-item-btn').addEventListener('click', () => openModal());
    container.addEventListener('click', async (e) => {
        if (e.target.classList.contains('edit-item-btn')) {
            const { data } = await supabase.from('products').select('*').eq('id', e.target.dataset.id).single();
            openModal(data);
        }
         if (e.target.classList.contains('delete-item-btn')) {
            if(confirm('Are you sure you want to delete this item?')) {
                const { error } = await supabase.from('products').delete().eq('id', e.target.dataset.id);
                if (error) showToast(`Error: ${error.message}`, true);
                else showToast('Item deleted.');
            }
        }
    });
}

async function renderCustomers(container) {
    container.innerHTML = `<div class="bg-card p-4 rounded-lg shadow-sm" id="customer-list"><p class="text-center text-muted-foreground p-4">Loading customer data...</p></div>`;
    const listContainer = $('#customer-list');

    const [customerRes, orderRes] = await Promise.all([
        supabase.from('customers').select('*'),
        supabase.from('orders').select('customer_id, total_amount').eq('status', 'delivered')
    ]);

    if (customerRes.error || orderRes.error) {
        listContainer.innerHTML = `<p class="text-destructive">Error loading customer data.</p>`;
        console.error(customerRes.error || orderRes.error);
        return;
    }

    const customers = customerRes.data;
    const orders = orderRes.data;

    const summary = new Map();
    customers.forEach(c => {
        summary.set(c.id, { name: c.name, total_orders: 0, total_spent: 0 });
    });

    orders.forEach(order => {
        if (summary.has(order.customer_id)) {
            let customerData = summary.get(order.customer_id);
            customerData.total_orders += 1;
            customerData.total_spent += order.total_amount;
        }
    });
    
    const summaryList = Array.from(summary.entries()).map(([id, data]) => ({
        customer_id: id, ...data
    }));

    listContainer.innerHTML = `
        <div class="grid grid-cols-5 gap-4 font-semibold text-sm text-muted-foreground px-4 py-2 border-b border-border">
            <div class="col-span-2">Name</div>
            <div>Total Orders</div>
            <div>Total Spent</div>
            <div>Actions</div>
        </div>
        <div class="divide-y divide-border">
        ${summaryList.map(c => `
            <div class="grid grid-cols-5 gap-4 px-4 py-3 text-sm items-center">
                <div class="col-span-2 font-medium">${c.name}</div>
                <div>${c.total_orders}</div>
                <div>₹${c.total_spent.toFixed(2)}</div>
                <div><button onclick="deleteCustomer('${c.customer_id}')" class="text-destructive text-xs hover:underline">Delete</button></div>
            </div>
        `).join('')}
        </div>
    `;
}

async function renderAnalytics(container) {
    container.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-card p-6 rounded-lg shadow-sm">
                <h3 class="font-semibold mb-4">Daily Revenue</h3>
                <canvas id="revenueChart"></canvas>
            </div>
            <div class="bg-card p-6 rounded-lg shadow-sm">
                <h3 class="font-semibold mb-4">Top Selling Products</h3>
                <canvas id="topItemsChart"></canvas>
            </div>
        </div>`;

    setTimeout(async () => {
        const { data: orders, error } = await supabase
            .from('orders')
            .select('created_at, total_amount, order_items(*, products(name))')
            .eq('status', 'delivered');

        if (error) {
            console.error(error);
            return;
        }

        // Process Daily Revenue
        const dailyRevenue = orders.reduce((acc, order) => {
            const date = new Date(order.created_at).toLocaleDateString();
            acc[date] = (acc[date] || 0) + order.total_amount;
            return acc;
        }, {});
        
        if ($('#revenueChart')) {
            new Chart($('#revenueChart'), {
                type: 'line',
                data: {
                    labels: Object.keys(dailyRevenue),
                    datasets: [{ label: 'Revenue', data: Object.values(dailyRevenue), borderColor: 'var(--primary)', tension: 0.1 }]
                }
            });
        }
        
        // Process Top Selling Products
        const productSales = orders.flatMap(order => order.order_items).reduce((acc, item) => {
            if (!item.products) return acc;
            const productName = item.products.name;
            acc[productName] = (acc[productName] || 0) + item.quantity;
            return acc;
        }, {});

        const topProducts = Object.entries(productSales)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5);

        if ($('#topItemsChart')) {
            new Chart($('#topItemsChart'), {
                type: 'bar',
                data: {
                    labels: topProducts.map(([name]) => name),
                    datasets: [{ label: 'Quantity Sold', data: topProducts.map(([, quantity]) => quantity), backgroundColor: 'var(--primary)' }]
                },
                options: { indexAxis: 'y' }
            });
        }
    }, 0);
}

async function renderFeedback(container) {
    container.innerHTML = `<div class="space-y-4" id="feedback-list"></div>`;
    const listContainer = $('#feedback-list');
    const { data, error } = await supabase.from('feedback').select('*, customers(name)').order('created_at', { ascending: false });
    if (error) { listContainer.innerHTML = `<p class="text-destructive">Error loading feedback.</p>`; return; }
    
    if(data.length === 0) { listContainer.innerHTML = `<p class="text-muted-foreground">No feedback yet.</p>`; return; }
    listContainer.innerHTML = data.map(f => `
        <div class="bg-card p-4 rounded-lg border border-border">
            <div class="flex justify-between items-start">
                <p class="font-semibold">${f.customers?.name || 'Anonymous'}</p>
                <span class="text-sm text-muted-foreground">${new Date(f.created_at).toLocaleString()}</span>
            </div>
            <p class="mt-2">${f.content}</p>
        </div>
    `).join('');
}


async function renderGames(container){
     container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Trivia Questions</h3>
                    <button id="add-trivia-btn" class="bg-primary text-primary-foreground px-4 py-2 rounded-lg text-sm font-medium">Add Trivia</button>
                </div>
                <div id="trivia-list" class="space-y-3"></div>
            </div>
             <div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Slang Words</h3>
                    <button id="add-slang-btn" class="bg-primary text-primary-foreground px-4 py-2 rounded-lg text-sm font-medium">Add Slang</button>
                </div>
                <div id="slang-list" class="space-y-3"></div>
            </div>
        </div>
    `;

    const loadGamesData = async () => {
        const [triviaRes, slangRes] = await Promise.all([
            supabase.from('game_trivia').select('*'),
            supabase.from('game_slang').select('*')
        ]);

        const triviaContainer = $('#trivia-list');
        if(triviaRes.error) triviaContainer.innerHTML = `<p class="text-destructive">Error loading trivia.</p>`
        else triviaContainer.innerHTML = triviaRes.data.map(t => `<div class="bg-card p-3 rounded-md border border-border">
            <p class="font-semibold">${t.question}</p>
            <div class="flex space-x-2 mt-2">
                <button onclick="games.openTriviaModal(${t.id})" class="text-xs text-blue-600">Edit</button>
                <button onclick="games.deleteTrivia(${t.id})" class="text-xs text-destructive">Delete</button>
            </div>
        </div>`).join('');

        const slangContainer = $('#slang-list');
        if(slangRes.error) slangContainer.innerHTML = `<p class="text-destructive">Error loading slang.</p>`
        else slangContainer.innerHTML = slangRes.data.map(s => `<div class="bg-card p-3 rounded-md border border-border">
            <p class="font-semibold">${s.word}: <span class="font-normal">${s.definition}</span></p>
             <div class="flex space-x-2 mt-2">
                <button onclick="games.openSlangModal(${s.id})" class="text-xs text-blue-600">Edit</button>
                <button onclick="games.deleteSlang(${s.id})" class="text-xs text-destructive">Delete</button>
            </div>
        </div>`).join('');
    }

    await loadGamesData();
    $('#add-trivia-btn').addEventListener('click', () => games.openTriviaModal());
    $('#add-slang-btn').addEventListener('click', () => games.openSlangModal());
}

async function renderQrGenerator(container) {
    container.innerHTML = `
        <div class="max-w-md mx-auto bg-card p-8 rounded-lg shadow-sm">
            <h3 class="text-lg font-semibold text-center mb-4">Generate Table QR Code</h3>
            <div class="flex space-x-2">
                <input type="number" id="table-number-input" placeholder="Enter table number" class="w-full p-2 bg-secondary rounded-md border border-border">
                <button id="generate-qr-btn" class="bg-primary text-primary-foreground px-4 py-2 rounded-lg font-medium">Generate</button>
            </div>
            <div id="qrcode-container" class="mt-6 flex flex-col items-center justify-center bg-secondary p-4 rounded-lg hidden">
                <h4 id="qr-title" class="font-semibold mb-2"></h4>
                <div id="qrcode" class="bg-white p-4 rounded-md"></div>
                 <button id="print-qr-btn" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg text-sm">Print QR Code</button>
            </div>
        </div>
    `;

    $('#generate-qr-btn').addEventListener('click', () => {
        const tableNumber = $('#table-number-input').value;
        if (!tableNumber) { showToast('Please enter a table number.', true); return; }
        
        const url = `https://namoshersingh1.onrender.com/?table=${tableNumber}`;
        const qrcodeContainer = $('#qrcode');
        qrcodeContainer.innerHTML = '';
        
        const qr = qrcode(0, 'L');
        qr.addData(url);
        qr.make();
        qrcodeContainer.innerHTML = qr.createImgTag(6, 8);
        
        $('#qr-title').textContent = `QR Code for Table #${tableNumber}`;
        $('#qrcode-container').classList.remove('hidden');
    });

    $('#print-qr-btn').addEventListener('click', () => {
        const qrContent = $('#qrcode-container').innerHTML;
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Print QR Code</title><style>body { font-family: sans-serif; text-align: center; margin-top: 50px; }</style></head><body>');
        printWindow.document.write(qrContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    });
}

async function renderPosBridge(container, params) {
    if (!params || !params.orderId) {
        container.innerHTML = `<p class="text-destructive">Error: No order ID provided.</p>`;
        return;
    }
    const orderId = params.orderId;
    const PETPOOJA_URL = 'https://pos.petpooja.com/'; 

    container.innerHTML = `
        <div class="bg-card rounded-lg shadow-sm h-full flex flex-col">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 flex-grow">
                <!-- Left Column: Order Details -->
                <div class="md:col-span-1 bg-secondary p-4 rounded-lg overflow-y-auto" id="pos-bridge-order-details">
                    <p class="text-center text-muted-foreground">Loading order details...</p>
                </div>
                <!-- Right Column: Pet Pooja Iframe -->
                <div class="md:col-span-2 border border-border rounded-lg overflow-hidden">
                    <iframe src="${PETPOOJA_URL}" class="w-full h-full border-0"></iframe>
                </div>
            </div>
        </div>
    `;

    const detailsContainer = $('#pos-bridge-order-details');
    try {
        const { data: order, error } = await supabase
            .from('orders')
            .select('*, customers(name), tables(table_number), order_items(*, products(name))')
            .eq('id', orderId)
            .single();

        if (error || !order) throw new Error(error?.message || 'Order not found');

        let orderDetailsHtml = `
            <h3 class="font-display text-xl font-bold mb-2">Order Entry</h3>
            <div class="space-y-4">
                <div class="bg-card p-3 rounded-md">
                    <p class="text-sm text-muted-foreground">Order ID</p>
                    <p class="font-mono text-sm">${order.id.slice(0, 8)}</p>
                </div>
                <div class="bg-card p-3 rounded-md">
                    <p class="text-sm text-muted-foreground">Table & Customer</p>
                    <p class="font-semibold text-lg">Table: ${order.tables.table_number}</p>
                    <p class="font-semibold text-lg">Customer: ${order.customers.name}</p>
                </div>
                <div class="bg-card p-3 rounded-md">
                    <p class="text-sm text-muted-foreground mb-2">Items</p>
                    <ul class="divide-y divide-border">
                        ${order.order_items.map(item => `
                            <li class="py-2">
                                <p class="font-bold text-lg">${item.products ? item.products.name : '[Deleted Item]'}</p>
                                <p class="text-muted-foreground">Quantity: <span class="font-mono text-lg font-bold">${item.quantity}</span></p>
                            </li>
                        `).join('')}
                    </ul>
                </div>
        `;
        if (order.special_instructions) {
            orderDetailsHtml += `
                <div class="bg-red-50 border border-red-200 p-3 rounded-md">
                    <p class="text-sm text-red-700 font-bold">Special Instructions</p>
                    <p class="text-red-900">${order.special_instructions}</p>
                </div>
            `;
        }
         orderDetailsHtml += `</div>`;
        detailsContainer.innerHTML = orderDetailsHtml;

    } catch (e) {
        detailsContainer.innerHTML = `<p class="text-destructive">Failed to load order details: ${e.message}</p>`;
    }
}


// =================================================================================
//  SECTION 4: ACTION HANDLERS
// =================================================================================

async function updateOrderStatus(orderId, newStatus) {
    const { error } = await supabase.from('orders').update({ status: newStatus }).eq('id', orderId);
    if (error) showToast('Could not update order.', true);
}

async function resolveStaffCall(callId) {
    const { error } = await supabase.from('staff_calls').update({ status: 'resolved' }).eq('id', callId);
    if (error) showToast('Could not resolve call.', true);
}

function openPosBridge(orderId) {
    navigateTo('pos_bridge', { orderId });
}

async function deleteCustomer(customerId) {
    if(confirm('Are you sure? This will delete the customer and all their associated data.')) {
        const { error } = await supabase.rpc('delete_customer_data', { customer_id_to_delete: customerId });
        if(error) showToast(`Error: ${error.message}`, true);
        else showToast('Customer data deleted.');
    }
}

async function deleteOrder(orderId) {
     if(confirm('Are you sure? This will delete this order and its items.')) {
        const { error } = await supabase.rpc('delete_order_data', { order_id_to_delete: orderId });
        if(error) showToast(`Error: ${error.message}`, true);
        else showToast('Order data deleted.');
    }
}


// =================================================================================
//  SECTION 5: POS & KOT LOGIC
// =================================================================================

const pos = {
    addToCart(itemId) {
        const flatMenu = Object.values(state.menuData).flat();
        const item = flatMenu.find(i => i.id === itemId);
        const existingItem = state.posCart.find(i => i.id === itemId);
        if (existingItem) existingItem.quantity++;
        else state.posCart.push({ ...item, quantity: 1 });
        this.renderCart();
    },

    renderCart() {
        const cartContainer = $('#pos-cart');
        if (!cartContainer) return;
        if (state.posCart.length === 0) {
            cartContainer.innerHTML = `<p class="text-muted-foreground text-sm">Select items from the menu.</p>`;
            $('#pos-total').textContent = '₹0.00';
            return;
        }
        const total = state.posCart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        cartContainer.innerHTML = state.posCart.map(item => `<div class="flex justify-between items-center text-sm"><div><p class="font-semibold">${item.name}</p><p class="text-xs text-muted-foreground">₹${item.price} x ${item.quantity}</p></div><div class="font-semibold">₹${(item.price * item.quantity).toFixed(2)}</div></div>`).join('');
        $('#pos-total').textContent = `₹${total.toFixed(2)}`;
    },

    async placeOrder() {
        const tableNumber = $('#pos-table-number').value;
        const customerName = $('#pos-customer-name').value || 'Counter';
        
        if (!tableNumber) { showToast('Please enter a table number.', true); return; }
        if (state.posCart.length === 0) { showToast('Cart is empty.', true); return; }
        
        let { data: customer } = await supabase.from('customers').select('id').eq('name', customerName).single();
        if (!customer) {
            const { data: newCustomer, error: customerError } = await supabase.from('customers').insert({ name: customerName, id: crypto.randomUUID() }).select().single();
            if (customerError) { showToast(`Error creating customer: ${customerError.message}`, true); return; }
            customer = newCustomer;
        }

        const { data: table } = await supabase.from('tables').select('id').eq('table_number', tableNumber).single();
        if (!table) { showToast(`Table #${tableNumber} does not exist.`, true); return; }

        const total = state.posCart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const { data: order, error: orderError } = await supabase.from('orders').insert({ customer_id: customer.id, table_id: table.id, total_amount: total, status: 'preparing' }).select().single();
        if (orderError) { showToast(`Error creating order: ${orderError.message}`, true); return; }

        const orderItems = state.posCart.map(item => ({ order_id: order.id, product_id: item.id, quantity: item.quantity, price_at_time_of_order: item.price }));
        const { error: itemsError } = await supabase.from('order_items').insert(orderItems);
        if (itemsError) { showToast(`Error saving items: ${itemsError.message}`, true); return; }
        
        showToast(`Order for Table #${tableNumber} placed.`);
        state.posCart = [];
        this.renderCart();
        $('#pos-table-number').value = '';
        $('#pos-customer-name').value = '';
        this.printKOT(order.id);
    },

    async printKOT(orderId) {
        const { data: order, error } = await supabase.from('orders').select('*, customers(name), tables(table_number), order_items(*, products(name))').eq('id', orderId).single();
        if (error) { showToast('Could not fetch order for KOT.', true); return; }

        const printWindow = window.open('', '', 'height=600,width=400');
        printWindow.document.write(`
            <html><head><title>KOT</title><style>body{font-family:monospace;margin:0;padding:10px}h2,p{margin:0}hr{border:none;border-top:1px dashed #000}.header{text-align:center;margin-bottom:10px}.item{display:flex;justify-content:space-between;font-size:14px;margin:5px 0}</style></head><body>
                <div class="header"><h2>KOT - Namo Tandoori Chai</h2><p>Order #${order.id.slice(0,6)}</p></div><hr>
                <p><strong>Table: ${order.tables.table_number}</strong> | ${new Date(order.created_at).toLocaleTimeString()}</p><hr>
                ${order.order_items.map(item => `<div class="item"><span>${item.quantity} x ${item.products.name}</span></div>`).join('')}
                ${order.special_instructions ? `<hr><p><strong>Notes:</strong> ${order.special_instructions}</p>`: ''}
            </body></html>`);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }
};

const games = {
    async openTriviaModal(id = null) {
        const { data: trivia } = id ? await supabase.from('game_trivia').select('*').eq('id', id).single() : { data: null };
        showModal('trivia-modal', `
            <h3 class="text-lg font-semibold mb-4">${id ? 'Edit' : 'Add'} Trivia Question</h3>
            <form id="trivia-form" class="space-y-4">
                <input type="hidden" id="trivia-id" value="${id || ''}">
                <div><label>Question</label><input type="text" id="trivia-q" class="w-full mt-1 p-2 bg-secondary rounded-md" value="${trivia?.question || ''}" required></div>
                <div><label>Options (comma-separated)</label><input type="text" id="trivia-opts" class="w-full mt-1 p-2 bg-secondary rounded-md" value="${trivia?.options.join(', ') || ''}" required></div>
                <div><label>Correct Answer Index (0-3)</label><input type="number" id="trivia-a" class="w-full mt-1 p-2 bg-secondary rounded-md" value="${trivia?.correct_answer_index ?? ''}" required></div>
                <div class="flex justify-end space-x-2"><button type="button" onclick="closeModal('trivia-modal')">Cancel</button><button type="submit">Save</button></div>
            </form>`);
        $('#trivia-form').addEventListener('submit', this.handleTriviaSubmit);
    },
    async handleTriviaSubmit(e) {
        e.preventDefault();
        const id = $('#trivia-id').value;
        const data = {
            question: $('#trivia-q').value,
            options: $('#trivia-opts').value.split(',').map(s => s.trim()),
            correct_answer_index: parseInt($('#trivia-a').value)
        };
        const { error } = id ? await supabase.from('game_trivia').update(data).eq('id', id) : await supabase.from('game_trivia').insert(data);
        if (error) showToast(`Error: ${error.message}`, true);
        else { showToast('Trivia saved.'); closeModal('trivia-modal'); }
    },
    async deleteTrivia(id) {
        if(confirm('Delete this trivia question?')) {
            const { error } = await supabase.from('game_trivia').delete().eq('id', id);
            if(error) showToast(`Error: ${error.message}`, true);
            else showToast('Trivia deleted.');
        }
    },
    async openSlangModal(id = null) {
        const { data: slang } = id ? await supabase.from('game_slang').select('*').eq('id', id).single() : { data: null };
        showModal('slang-modal', `
            <h3 class="text-lg font-semibold mb-4">${id ? 'Edit' : 'Add'} Slang</h3>
            <form id="slang-form" class="space-y-4">
                 <input type="hidden" id="slang-id" value="${id || ''}">
                <div><label>Word</label><input type="text" id="slang-w" class="w-full mt-1 p-2 bg-secondary rounded-md" value="${slang?.word || ''}" required></div>
                <div><label>Definition</label><input type="text" id="slang-d" class="w-full mt-1 p-2 bg-secondary rounded-md" value="${slang?.definition || ''}" required></div>
                <div class="flex justify-end space-x-2"><button type="button" onclick="closeModal('slang-modal')">Cancel</button><button type="submit">Save</button></div>
            </form>`);
        $('#slang-form').addEventListener('submit', this.handleSlangSubmit);
    },
    async handleSlangSubmit(e) {
        e.preventDefault();
        const id = $('#slang-id').value;
        const data = { word: $('#slang-w').value, definition: $('#slang-d').value };
        const { error } = id ? await supabase.from('game_slang').update(data).eq('id', id) : await supabase.from('game_slang').insert(data);
        if (error) showToast(`Error: ${error.message}`, true);
        else { showToast('Slang saved.'); closeModal('slang-modal'); }
    },
     async deleteSlang(id) {
        if(confirm('Delete this slang word?')) {
            const { error } = await supabase.from('game_slang').delete().eq('id', id);
            if(error) showToast(`Error: ${error.message}`, true);
            else showToast('Slang deleted.');
        }
    },
}

function applyTheme(theme) {
    if (theme === 'dark') {
        document.documentElement.classList.add('dark');
        document.documentElement.classList.remove('light');
        $('#theme-icon-dark').classList.remove('hidden');
        $('#theme-icon-light').classList.add('hidden');
    } else {
        document.documentElement.classList.add('light');
        document.documentElement.classList.remove('dark');
        $('#theme-icon-light').classList.remove('hidden');
        $('#theme-icon-dark').classList.add('hidden');
    }
    localStorage.setItem('theme', theme);
}

// =================================================================================
//  APP INITIALIZATION
// =================================================================================
document.addEventListener('DOMContentLoaded', () => {
    $('#login-form').addEventListener('submit', (e) => { e.preventDefault(); auth.login(); });
    $('#logout-btn').addEventListener('click', auth.logout);
    $('#theme-toggle').addEventListener('click', () => { applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'); });
    auth.checkSession();
});
</script>

</body>
</html>

